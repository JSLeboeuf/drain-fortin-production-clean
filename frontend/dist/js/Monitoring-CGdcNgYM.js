import{j as e,r as t}from"./ui-QtlX95wh.js";import{c as s,a,b as r,u as i,B as n,L as l,d as c,R as d,C as o,e as x,f as m,g as u,T as h,A as p,h as g,U as f}from"./index-CC77URC1.js";import{u as b,P as j}from"./phone-BA2yAo7b.js";import{s as y,a as N}from"./supabase--zxEpOZW.js";import{useWebSocket as v}from"./useWebSocket-CzK3T2Bt.js";import{C as w}from"./clock-Ct5QRIBV.js";import{T as k}from"./trending-up-BGNHXRiI.js";import"./react-vendor-C_mTfbPB.js";import"./supabase-DcuI07gC.js";import"./utils-BHC4lWY-.js";import"./index-BxQ2FslJ.js";const C=s("circle-check-big",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]),T=s("circle-x",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]]),S=s("eye",[["path",{d:"M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0",key:"1nclc0"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]),$=s("headphones",[["path",{d:"M3 14h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-7a9 9 0 0 1 18 0v7a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3",key:"1xhozi"}]]),A=s("phone-call",[["path",{d:"M13 2a9 9 0 0 1 9 9",key:"1itnx2"}],["path",{d:"M13 6a5 5 0 0 1 5 5",key:"11nki7"}],["path",{d:"M13.832 16.568a1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 6.392 6.384",key:"9njp5v"}]]),P=r("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-drain-blue-500 focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-drain-blue-500 text-white hover:bg-drain-blue-600",secondary:"border-transparent bg-drain-orange-500 text-white hover:bg-drain-orange-600",destructive:"border-transparent bg-priority-p1 text-white hover:bg-red-700",outline:"text-drain-steel-600 border-drain-steel-300",success:"border-transparent bg-drain-green-500 text-white hover:bg-drain-green-600",priority1:"priority-p1",priority2:"priority-p2",priority3:"priority-p3",priority4:"priority-p4"}},defaultVariants:{variant:"default"}});function M({className:t,variant:s,...r}){return e.jsx("div",{className:a(P({variant:s}),t),...r})}const L="http://localhost:8080";async function q(e,t){try{const s=await fetch(`${L}${e}`,{...t,headers:{"Content-Type":"application/json",...t?.headers},credentials:"include"});if(!s.ok)throw new Error(`API Error: ${s.status} ${s.statusText}`);return await s.json()}catch(s){throw s}}const R={async getCalls(){try{return await q("/api/calls")}catch{return(await N.getRecentCalls(50)).map(e=>({id:e.id,phoneNumber:e.phone_number,startTime:new Date(e.started_at),endTime:e.ended_at?new Date(e.ended_at):void 0,duration:e.duration||0,transcript:e.transcript||"",priority:e.priority||"P4",status:e.status||"completed",recordingUrl:e.recording_url,metadata:e.metadata||{}}))}},async getCall(e){try{return await q(`/api/calls/${e}`)}catch{const{data:t}=await y.from("vapi_calls").select("*").eq("id",e).single();return t}},async getLeads(){try{return await q("/api/leads")}catch{return await N.getLeads()}},async createLead(e){try{return await q("/api/leads",{method:"POST",body:JSON.stringify(e)})}catch{const{data:t,error:s}=await y.from("leads").insert(e).select().single();if(s)throw s;return t}},async getAnalytics(){try{return await q("/api/analytics")}catch{return await N.getDashboardMetrics()}},async getSettings(){try{return await q("/api/settings")}catch{return{constraints:[],pricing:{},prompts:{},webhooks:{url:void 0}}}},async updateSettings(e){try{return await q("/api/settings",{method:"PUT",body:JSON.stringify(e)})}catch(t){throw t}},async testConnection(){const e={backend:!1,supabase:!1};try{await fetch(`${L}/health`),e.backend=!0}catch{e.backend=!1}try{const{error:t}=await y.from("vapi_calls").select("count").limit(1);e.supabase=!t}catch{e.supabase=!1}return e}};function D(){const e=i();t.useEffect(()=>{const t=N.subscribeToNewCalls(t=>{e.invalidateQueries({queryKey:["supabase","calls"]}),e.invalidateQueries({queryKey:["supabase","dashboard_metrics"]})});return()=>{t.unsubscribe()}},[e])}function _({call:s,onListen:r,onTransfer:i}){const[l,c]=t.useState(s.duration);return t.useEffect(()=>{const e=setInterval(()=>{c(e=>e+1)},1e3);return()=>clearInterval(e)},[]),e.jsxs("div",{className:a("border rounded-lg p-4",(e=>{switch(e){case"P1":return"priority-p1 card-premium animate-pulse-urgent border-l-4 border-l-priority-p1";case"P2":return"priority-p2 card-premium border-l-4 border-l-drain-orange-500";case"P3":return"priority-p3 card-premium border-l-4 border-l-drain-orange-300";case"P4":return"priority-p4 card-premium border-l-4 border-l-drain-green-500";default:return"card-premium border-border bg-card"}})(s.priority)),"data-testid":`card-live-call-${s.id}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:a("px-2 py-1 text-xs font-medium rounded-full",(e=>{switch(e){case"P1":return"bg-gradient-to-r from-priority-p1 to-red-700 text-white shadow-lg";case"P2":return"bg-gradient-to-r from-drain-orange-500 to-drain-orange-600 text-white shadow-lg";case"P3":return"bg-gradient-to-r from-drain-orange-400 to-drain-orange-500 text-white shadow-lg";case"P4":return"bg-gradient-to-r from-drain-green-500 to-drain-green-600 text-white shadow-lg";default:return"bg-drain-steel-500 text-white"}})(s.priority)),"data-testid":`badge-priority-${s.priority}`,children:s.priority}),e.jsx("span",{className:"font-mono text-sm text-foreground","data-testid":`text-phone-${s.id}`,children:s.phoneNumber})]}),e.jsx("span",{className:"text-sm text-muted-foreground","data-testid":`text-duration-${s.id}`,children:(e=>{const t=e%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`})(l)})]}),e.jsx("p",{className:"text-sm text-muted-foreground mb-3 line-clamp-2","data-testid":`text-transcript-${s.id}`,children:s.transcript||"En attente de transcription..."}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs(n,{size:"sm",variant:"default",onClick:r,className:"text-xs","data-testid":`button-listen-${s.id}`,children:[e.jsx($,{className:"h-3 w-3 mr-1"}),"Écouter"]}),e.jsxs(n,{size:"sm",variant:"destructive",onClick:i,className:"text-xs","data-testid":`button-transfer-${s.id}`,children:[e.jsx(A,{className:"h-3 w-3 mr-1"}),"Transférer"]})]})]})}const z=t.forwardRef(({className:t,...s},r)=>e.jsx("div",{className:"relative w-full overflow-auto",children:e.jsx("table",{ref:r,className:a("w-full caption-bottom text-sm",t),...s})}));z.displayName="Table";const E=t.forwardRef(({className:t,...s},r)=>e.jsx("thead",{ref:r,className:a("[&_tr]:border-b",t),...s}));E.displayName="TableHeader";const I=t.forwardRef(({className:t,...s},r)=>e.jsx("tbody",{ref:r,className:a("[&_tr:last-child]:border-0",t),...s}));I.displayName="TableBody",t.forwardRef(({className:t,...s},r)=>e.jsx("tfoot",{ref:r,className:a("border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",t),...s})).displayName="TableFooter";const K=t.forwardRef(({className:t,...s},r)=>e.jsx("tr",{ref:r,className:a("border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",t),...s}));K.displayName="TableRow";const F=t.forwardRef(({className:t,...s},r)=>e.jsx("th",{ref:r,className:a("h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",t),...s}));F.displayName="TableHead";const O=t.forwardRef(({className:t,...s},r)=>e.jsx("td",{ref:r,className:a("p-4 align-middle [&:has([role=checkbox])]:pr-0",t),...s}));O.displayName="TableCell",t.forwardRef(({className:t,...s},r)=>e.jsx("caption",{ref:r,className:a("mt-4 text-sm text-muted-foreground",t),...s})).displayName="TableCaption";const H=t.memo(function({calls:s,showActions:r=!0,onSortChange:i,sortKey:c,sortDir:d}){const o=t.useCallback(e=>new Date(e).toLocaleTimeString("fr-CA",{hour:"2-digit",minute:"2-digit"}),[]),x=t.useCallback(e=>`${Math.floor(e/60)}:${(e%60).toString().padStart(2,"0")}`,[]),m=t.useMemo(()=>({P1:"bg-red-600 text-white",P2:"bg-orange-600 text-white",P3:"bg-yellow-600 text-white",P4:"bg-green-600 text-white",default:"bg-gray-600 text-white"}),[]),u=t.useMemo(()=>({completed:"bg-green-100 text-green-800 dark:bg-green-950 dark:text-green-400",transferred:"bg-blue-100 text-blue-800 dark:bg-blue-950 dark:text-blue-400",active:"bg-yellow-100 text-yellow-800 dark:bg-yellow-950 dark:text-yellow-400",failed:"bg-red-100 text-red-800 dark:bg-red-950 dark:text-red-400",default:"bg-gray-100 text-gray-800 dark:bg-gray-950 dark:text-gray-400"}),[]),h=t.useMemo(()=>({completed:"Complété",transferred:"Transféré",active:"Actif",failed:"Échoué"}),[]),p=t.useCallback(e=>e?.service?e.service:e?.scenario?e.scenario:"Service non spécifié",[]),g=t.useCallback(e=>{i?.(e)},[i]),f=t.useMemo(()=>e.jsx("div",{className:"text-center py-8 text-muted-foreground","data-testid":"text-no-calls",children:"Aucun appel disponible"}),[]);return 0===s.length?f:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(z,{children:[e.jsx(E,{children:e.jsxs(K,{children:[e.jsx(F,{children:e.jsx("button",{className:"text-left font-medium focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded px-1","aria-label":"Trier par date","aria-sort":"date"===c?"asc"===d?"ascending":"descending":"none",onClick:()=>g("date"),children:"Heure"})}),e.jsx(F,{children:"Numéro"}),e.jsx(F,{children:e.jsx("button",{className:"text-left font-medium focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded px-1","aria-label":"Trier par durée","aria-sort":"duration"===c?"asc"===d?"ascending":"descending":"none",onClick:()=>g("duration"),children:"Durée"})}),e.jsx(F,{children:"Priorité"}),e.jsx(F,{children:e.jsx("button",{className:"text-left font-medium focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded px-1","aria-label":"Trier par statut","aria-sort":"status"===c?"asc"===d?"ascending":"descending":"none",onClick:()=>g("status"),children:"Statut"})}),e.jsx(F,{children:e.jsx("button",{className:"text-left font-medium focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded px-1","aria-label":"Trier par service","aria-sort":"service"===c?"asc"===d?"ascending":"descending":"none",onClick:()=>g("service"),children:"Service"})}),e.jsx(F,{children:e.jsx("button",{className:"text-left font-medium focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded px-1","aria-label":"Trier par tag","aria-sort":"tag"===c?"asc"===d?"ascending":"descending":"none",onClick:()=>g("tag"),children:"Tag"})}),r&&e.jsx(F,{children:"Actions"})]})}),e.jsx(I,{children:s.map(t=>e.jsxs(K,{className:"hover:bg-muted/50","data-testid":`row-call-${t.id}`,children:[e.jsx(O,{className:"text-sm text-foreground","data-testid":`text-time-${t.id}`,children:o(t.startTime)}),e.jsx(O,{className:"text-sm font-mono text-foreground","data-testid":`text-phone-${t.id}`,children:t.phoneNumber}),e.jsx(O,{className:"text-sm text-foreground","data-testid":`text-duration-${t.id}`,children:x(t.duration)}),e.jsx(O,{children:e.jsx("span",{className:a("px-2 py-1 text-xs font-medium rounded-full",m[t.priority]||m.default),"data-testid":`badge-priority-${t.id}`,children:t.priority})}),e.jsx(O,{children:e.jsx("span",{className:a("px-2 py-1 text-xs rounded-full",u[t.status]||u.default),"data-testid":`badge-status-${t.id}`,children:h[t.status]||t.status})}),e.jsx(O,{className:"text-sm text-foreground","data-testid":`text-service-${t.id}`,children:p(t.metadata)}),e.jsx(O,{className:"text-sm text-foreground","data-testid":`text-tag-${t.id}`,children:t.metadata?.tag??t.metadata?.intent??"—"}),r&&e.jsx(O,{children:e.jsx(l,{href:`/calls/${t.id}`,children:e.jsx(n,{variant:"ghost",size:"sm",className:"text-primary hover:text-primary/80","data-testid":`button-view-${t.id}`,children:e.jsx(S,{className:"h-4 w-4"})})})})]},t.id))})]})})});function U(){const[s,r]=t.useState(!1),{calls:i,metrics:l,connectionStatus:y,isLoading:S}=function(){const e=function(e=10){return b({queryKey:["supabase","calls",e],queryFn:()=>N.getRecentCalls(e),refetchInterval:1e4,staleTime:5e3,gcTime:3e5,refetchOnWindowFocus:!1,refetchOnMount:"always"})}(20),t=function(e=50){return b({queryKey:["supabase","leads",e],queryFn:()=>N.getLeads(e),refetchInterval:3e4})}(10),s=b({queryKey:["supabase","dashboard_metrics"],queryFn:()=>N.getDashboardMetrics(),refetchInterval:6e4}),a=b({queryKey:["connection","status"],queryFn:()=>R.testConnection(),refetchInterval:3e4,staleTime:2e4});return D(),{calls:Array.isArray(e.data)?e.data:[],leads:Array.isArray(t.data)?t.data:[],metrics:s.data||{totalCalls:0,totalLeads:0,urgentCalls:0,avgDuration:0,conversionRate:0},connectionStatus:a.data||{backend:!1,supabase:!1},isLoading:e.isLoading||t.isLoading||s.isLoading,error:e.error||t.error||s.error}}(),{activeCalls:$}=v();t.useEffect(()=>{const e=D();return()=>e},[]);const P=e=>{window.open(`tel:${e}`)},L=$?.filter(e=>"P1"===e.priority)||[],q="connected"===y?{icon:e.jsx(C,{className:"h-5 w-5 text-green-500"}),badge:e.jsx(M,{className:"bg-green-100 text-green-800",children:"En ligne"}),text:"Connexion active"}:"connecting"===y?{icon:e.jsx(w,{className:"h-5 w-5 text-yellow-500"}),badge:e.jsx(M,{className:"bg-yellow-100 text-yellow-800",children:"Connexion..."}),text:"Connexion en cours"}:{icon:e.jsx(T,{className:"h-5 w-5 text-red-500"}),badge:e.jsx(M,{className:"bg-red-100 text-red-800",children:"Hors ligne"}),text:"Connexion perdue"};return S?e.jsx("div",{className:"flex h-screen items-center justify-center bg-gray-50",children:e.jsxs("div",{className:"text-center",children:[e.jsx(c,{size:"lg"}),e.jsx("p",{className:"text-gray-600 mt-4",children:"Chargement du monitoring..."})]})}):e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsxs("div",{className:"container mx-auto p-6 space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Monitoring en Temps Réel"}),e.jsx("p",{className:"text-gray-600 mt-2",children:"Surveillance des appels actifs et métriques système"})]}),e.jsxs(n,{onClick:async()=>{r(!0);try{window.location.reload()}catch(e){}finally{r(!1)}},disabled:s,className:"gap-2",children:[e.jsx(d,{className:a("h-4 w-4",s&&"animate-spin")}),"Actualiser"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs(o,{children:[e.jsx(x,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(m,{className:"text-lg font-semibold",children:"Statut Connexion"}),q.badge]})}),e.jsx(u,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[q.icon,e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:q.text}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Dernière mise à jour: ",(new Date).toLocaleTimeString("fr-CA")]})]})]})})]}),L.length>0&&e.jsxs(o,{className:"border-red-200 bg-red-50",children:[e.jsx(x,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{className:"h-5 w-5 text-red-600"}),e.jsx(m,{className:"text-lg font-semibold text-red-800",children:"Urgences P1"}),e.jsx(M,{className:"bg-red-600 text-white",children:L.length})]})}),e.jsx(u,{children:e.jsxs("p",{className:"text-red-700 font-medium",children:[L.length," appel",L.length>1?"s":""," urgent",L.length>1?"s":""," nécessitent une attention immédiate"]})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs(o,{children:[e.jsx(x,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(j,{className:"h-5 w-5 text-blue-600"}),e.jsx(m,{className:"text-sm font-medium",children:"Appels Actifs"})]})}),e.jsxs(u,{children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:$?.length||0}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"En cours"})]})]}),e.jsxs(o,{children:[e.jsx(x,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(A,{className:"h-5 w-5 text-green-600"}),e.jsx(m,{className:"text-sm font-medium",children:"Appels Aujourd'hui"})]})}),e.jsxs(u,{children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:l?.totalCalls||0}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"Total"})]})]}),e.jsxs(o,{children:[e.jsx(x,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(w,{className:"h-5 w-5 text-purple-600"}),e.jsx(m,{className:"text-sm font-medium",children:"Durée Moyenne"})]})}),e.jsxs(u,{children:[e.jsxs("div",{className:"text-2xl font-bold text-purple-600",children:[Math.round(l?.avgDuration||0),"s"]}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"Par appel"})]})]}),e.jsxs(o,{children:[e.jsx(x,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{className:"h-5 w-5 text-red-600"}),e.jsx(m,{className:"text-sm font-medium",children:"Urgences P1"})]})}),e.jsxs(u,{children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:L.length}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"Critiques"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(o,{children:[e.jsxs(x,{children:[e.jsxs(m,{className:"flex items-center gap-2",children:[e.jsx(p,{className:"h-5 w-5 text-blue-600"}),"Appels en Direct (",$?.length||0,")"]}),e.jsx(g,{children:"Surveillance temps réel des appels actifs"})]}),e.jsx(u,{children:$&&$.length>0?e.jsx("div",{className:"space-y-3 max-h-96 overflow-y-auto",children:$.slice(0,10).map(t=>e.jsx(_,{call:t,onAction:P},t.id))}):e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(j,{className:"h-12 w-12 mx-auto mb-3 text-gray-400"}),e.jsx("p",{className:"font-medium",children:"Aucun appel actif"}),e.jsx("p",{className:"text-sm",children:"Les appels entrants apparaîtront ici en temps réel"})]})})]}),e.jsxs(o,{children:[e.jsxs(x,{children:[e.jsxs(m,{className:"flex items-center gap-2",children:[e.jsx(k,{className:"h-5 w-5 text-green-600"}),"Performance Système"]}),e.jsx(g,{children:"Statut et métriques du système en temps réel"})]}),e.jsx(u,{children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"text-center p-4 bg-green-50 rounded-lg",children:[e.jsx(C,{className:"h-8 w-8 text-green-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm font-medium text-green-800",children:"Système"}),e.jsx("p",{className:"text-xs text-green-600",children:"Opérationnel"})]}),e.jsxs("div",{className:"text-center p-4 bg-blue-50 rounded-lg",children:[e.jsx(p,{className:"h-8 w-8 text-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm font-medium text-blue-800",children:"API"}),e.jsx("p",{className:"text-xs text-blue-600",children:"Connecté"})]}),e.jsxs("div",{className:"text-center p-4 bg-purple-50 rounded-lg",children:[e.jsx(f,{className:"h-8 w-8 text-purple-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm font-medium text-purple-800",children:"WebSocket"}),e.jsx("p",{className:"text-xs text-purple-600",children:q.text})]}),e.jsxs("div",{className:"text-center p-4 bg-yellow-50 rounded-lg",children:[e.jsx(w,{className:"h-8 w-8 text-yellow-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm font-medium text-yellow-800",children:"Latence"}),e.jsx("p",{className:"text-xs text-yellow-600",children:"< 100ms"})]})]})})]})]}),e.jsx(H,{calls:i||[],loading:S})]})})}export{U as default};
