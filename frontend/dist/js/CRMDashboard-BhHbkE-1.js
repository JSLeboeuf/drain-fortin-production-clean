import{r as e,j as s}from"./ui-QtlX95wh.js";import{u as t}from"./phone-BA2yAo7b.js";import{r,C as a,a as l,s as n,i,b as c}from"./ClientsView-DDXmF26m.js";import{c as d,A as o,U as x,T as m,a as u}from"./index-CC77URC1.js";import{u as h}from"./index-BxQ2FslJ.js";import{C as g}from"./clock-Ct5QRIBV.js";import{T as p}from"./trending-up-BGNHXRiI.js";import"./react-vendor-C_mTfbPB.js";import"./supabase-DcuI07gC.js";import"./supabase--zxEpOZW.js";import"./utils-BHC4lWY-.js";const b=d("calendar",[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]]),j=d("dollar-sign",[["line",{x1:"12",x2:"12",y1:"2",y2:"22",key:"7eqyqh"}],["path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6",key:"1b0p4s"}]]),y=d("message-square",[["path",{d:"M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z",key:"18887p"}]]);function v(){const[d,v]=e.useState("dashboard"),[M,C]=e.useState([]),{data:T}=t({queryKey:["crm-stats"],queryFn:()=>n.getStats(),refetchInterval:6e4}),{data:k=[],refetch:I}=t({queryKey:["active-alerts"],queryFn:()=>l.getActiveAlerts(),refetchInterval:3e4}),{data:_=[]}=t({queryKey:["today-interventions"],queryFn:()=>i.getTodayInterventions(),refetchInterval:6e4}),{data:q=[]}=t({queryKey:["recent-sms"],queryFn:()=>c.getSMSMessages({dateFrom:(new Date).toISOString().split("T")[0]}),refetchInterval:3e4});e.useEffect(()=>{const e=r.subscribeToAlerts(e=>{if("INSERT"===e.eventType){const s=e.new;C(e=>[s,...e]),h.error(`ðŸš¨ Nouvelle alerte ${s.priority}!`,{description:s.title,duration:1e4}),I()}}),s=r.subscribeToSMS(e=>{"INSERT"===e.eventType&&h.success("ðŸ“± SMS envoyÃ©",{description:"Un nouveau SMS a Ã©tÃ© envoyÃ© Ã  l'Ã©quipe"})}),t=r.subscribeToInterventions(e=>{"UPDATE"===e.eventType&&"completed"===e.new.status&&h.success("âœ… Intervention complÃ©tÃ©e",{description:`Service complÃ©tÃ© pour ${e.new.client_name}`})});return()=>{r.unsubscribe(e),r.unsubscribe(s),r.unsubscribe(t)}},[I]);const R=async e=>{try{await l.acknowledgeAlert(e,"current-user"),h.success("Alerte confirmÃ©e"),I()}catch(s){h.error("Erreur lors de la confirmation")}},P=async e=>{try{await l.resolveAlert(e,"current-user"),h.success("Alerte rÃ©solue"),I()}catch(s){h.error("Erreur lors de la rÃ©solution")}},D=e=>new Intl.NumberFormat("fr-CA",{style:"currency",currency:"CAD"}).format(e||0),F=[{id:"dashboard",label:"Tableau de bord",icon:o},{id:"clients",label:"Clients",icon:x},{id:"interventions",label:"Interventions",icon:b},{id:"sms",label:"Messages SMS",icon:y},{id:"alerts",label:"Alertes",icon:m,badge:k.length}];return s.jsxs("div",{className:"h-screen flex flex-col bg-gray-50",children:[s.jsxs("div",{className:"bg-white border-b px-6 py-4",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"CRM Drain Fortin"}),s.jsx("div",{className:"flex items-center gap-4",children:s.jsx("span",{className:"text-sm text-gray-500",children:(new Date).toLocaleDateString("fr-CA",{weekday:"long",year:"numeric",month:"long",day:"numeric"})})})]}),s.jsx("div",{className:"flex gap-2 mt-4",children:F.map(e=>{const t=e.icon;return s.jsxs("button",{onClick:()=>v(e.id),className:u("flex items-center gap-2 px-4 py-2 rounded-lg transition-colors relative",d===e.id?"bg-blue-600 text-white":"hover:bg-gray-100 text-gray-700"),children:[s.jsx(t,{className:"h-4 w-4"}),s.jsx("span",{children:e.label}),e.badge&&e.badge>0&&s.jsx("span",{className:u("absolute -top-1 -right-1 h-5 w-5 flex items-center justify-center text-xs font-bold rounded-full",d===e.id?"bg-red-500 text-white":"bg-red-600 text-white"),children:e.badge})]},e.id)})})]}),s.jsxs("div",{className:"flex-1 overflow-hidden",children:["dashboard"===d&&s.jsxs("div",{className:"p-6 space-y-6 overflow-y-auto h-full",children:[s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[s.jsx(f,{title:"Clients actifs",value:T?.activeClients||0,total:T?.totalClients||0,icon:x,color:"blue"}),s.jsx(f,{title:"Interventions aujourd'hui",value:T?.todayInterventions||0,total:T?.totalInterventions||0,icon:b,color:"green"}),s.jsx(f,{title:"SMS envoyÃ©s",value:T?.todaySMS||0,total:T?.totalSMS||0,icon:y,color:"purple"}),s.jsx(f,{title:"Revenus du mois",value:D(T?.monthRevenue),subtitle:`Total: ${D(T?.totalRevenue)}`,icon:j,color:"yellow"})]}),k.length>0&&s.jsxs("div",{className:"bg-white rounded-lg border",children:[s.jsx("div",{className:"p-4 border-b",children:s.jsxs("h2",{className:"text-lg font-semibold flex items-center gap-2",children:[s.jsx(m,{className:"h-5 w-5 text-red-600"}),"Alertes actives (",k.length,")"]})}),s.jsx("div",{className:"divide-y max-h-64 overflow-y-auto",children:k.slice(0,5).map(e=>s.jsx(w,{alert:e,onAcknowledge:R,onResolve:P},e.id))})]}),s.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[s.jsxs("div",{className:"bg-white rounded-lg border",children:[s.jsx("div",{className:"p-4 border-b",children:s.jsx("h2",{className:"text-lg font-semibold",children:"Interventions du jour"})}),s.jsx("div",{className:"divide-y max-h-96 overflow-y-auto",children:0===_.length?s.jsx("div",{className:"p-8 text-center text-gray-500",children:"Aucune intervention prÃ©vue aujourd'hui"}):_.map(e=>s.jsx(S,{intervention:e},e.id))})]}),s.jsxs("div",{className:"bg-white rounded-lg border",children:[s.jsx("div",{className:"p-4 border-b",children:s.jsx("h2",{className:"text-lg font-semibold",children:"SMS rÃ©cents"})}),s.jsx("div",{className:"divide-y max-h-96 overflow-y-auto",children:0===q.length?s.jsx("div",{className:"p-8 text-center text-gray-500",children:"Aucun SMS envoyÃ© aujourd'hui"}):q.slice(0,5).map(e=>s.jsx(A,{sms:e},e.id))})]})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[s.jsx(N,{title:"Temps de rÃ©ponse moyen",value:`${T?.averageResponseTime||15} min`,icon:g,trend:"+5%",trendUp:!1}),s.jsx(N,{title:"Satisfaction client",value:`${T?.customerSatisfaction||4.7}/5`,icon:p,trend:"+0.2",trendUp:!0}),s.jsx(N,{title:"Alertes P1/P2",value:`${T?.p1Alerts||0} / ${T?.p2Alerts||0}`,icon:m,subtitle:"Urgentes / Prioritaires"})]})]}),"clients"===d&&s.jsx(a,{}),"interventions"===d&&s.jsx("div",{className:"p-6",children:s.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Gestion des interventions"})}),"sms"===d&&s.jsx("div",{className:"p-6",children:s.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Historique SMS"})}),"alerts"===d&&s.jsx("div",{className:"p-6",children:s.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Centre d'alertes"})})]})]})}function f({title:e,value:t,total:r,subtitle:a,icon:l,color:n}){return s.jsx("div",{className:"bg-white rounded-lg border p-6",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm text-gray-600",children:e}),s.jsx("p",{className:"text-2xl font-semibold mt-1",children:t}),r&&s.jsxs("p",{className:"text-sm text-gray-500 mt-1",children:["sur ",r," total"]}),a&&s.jsx("p",{className:"text-sm text-gray-500 mt-1",children:a})]}),s.jsx("div",{className:u("p-3 rounded-lg",{blue:"bg-blue-50 text-blue-600",green:"bg-green-50 text-green-600",purple:"bg-purple-50 text-purple-600",yellow:"bg-yellow-50 text-yellow-600"}[n]),children:s.jsx(l,{className:"h-6 w-6"})})]})})}function N({title:e,value:t,icon:r,trend:a,trendUp:l,subtitle:n}){return s.jsxs("div",{className:"bg-white rounded-lg border p-4",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsx(r,{className:"h-5 w-5 text-gray-400"}),a&&s.jsx("span",{className:u("text-sm font-medium",l?"text-green-600":"text-red-600"),children:a})]}),s.jsx("p",{className:"text-2xl font-semibold",children:t}),s.jsx("p",{className:"text-sm text-gray-600 mt-1",children:e}),n&&s.jsx("p",{className:"text-xs text-gray-500 mt-1",children:n})]})}function w({alert:e,onAcknowledge:t,onResolve:r}){return s.jsx("div",{className:"p-4 hover:bg-gray-50",children:s.jsxs("div",{className:"flex items-start justify-between",children:[s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:u("px-2 py-0.5 text-xs font-medium rounded-full border",M(e.priority)),children:e.priority}),s.jsx("h3",{className:"font-medium",children:e.title})]}),s.jsxs("p",{className:"text-sm text-gray-600 mt-1",children:["Client: ",e.client_name," - ",e.client_phone]}),s.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Il y a ",e.minutes_since_created," minutes"]})]}),s.jsxs("div",{className:"flex gap-2",children:["pending"===e.status&&s.jsx("button",{onClick:()=>t(e.id),className:"px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700",children:"Confirmer"}),"acknowledged"===e.status&&s.jsx("button",{onClick:()=>r(e.id),className:"px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700",children:"RÃ©soudre"})]})]})})}function S({intervention:e}){return s.jsx("div",{className:"p-4 hover:bg-gray-50",children:s.jsxs("div",{className:"flex items-start justify-between",children:[s.jsxs("div",{children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("h3",{className:"font-medium",children:e.service_type}),s.jsx("span",{className:u("px-2 py-0.5 text-xs rounded-full",{pending:"bg-gray-100 text-gray-600",scheduled:"bg-blue-100 text-blue-600",in_progress:"bg-yellow-100 text-yellow-600",completed:"bg-green-100 text-green-600",cancelled:"bg-red-100 text-red-600"}[e.status||"pending"]),children:e.status})]}),s.jsxs("p",{className:"text-sm text-gray-600 mt-1",children:[e.client_name," - ",e.client_phone]}),s.jsx("p",{className:"text-sm text-gray-500",children:e.service_address})]}),s.jsxs("div",{className:"text-right",children:[s.jsx("p",{className:"text-sm font-medium",children:e.scheduled_time}),e.technician_name&&s.jsx("p",{className:"text-xs text-gray-500",children:e.technician_name})]})]})})}function A({sms:e}){return s.jsx("div",{className:"p-4 hover:bg-gray-50",children:s.jsx("div",{className:"flex items-start justify-between",children:s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:u("px-2 py-0.5 text-xs rounded-full","sent"===e.status?"bg-green-100 text-green-600":"failed"===e.status?"bg-red-100 text-red-600":"bg-gray-100 text-gray-600"),children:e.status}),e.priority&&s.jsx("span",{className:u("px-2 py-0.5 text-xs font-medium rounded-full border",M(e.priority)),children:e.priority})]}),s.jsx("p",{className:"text-sm text-gray-600 mt-1 line-clamp-2",children:e.message}),s.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Ã€: ",e.to_number," â€¢ ",new Date(e.sent_at||"").toLocaleTimeString("fr-CA")]})]})})})}function M(e){switch(e){case"P1":return"text-red-600 bg-red-100 border-red-200";case"P2":return"text-orange-600 bg-orange-100 border-orange-200";case"P3":return"text-yellow-600 bg-yellow-100 border-yellow-200";case"P4":return"text-green-600 bg-green-100 border-green-200";default:return"text-gray-600 bg-gray-100 border-gray-200"}}export{v as CRMDashboard};
