import{r as e}from"./ui-QtlX95wh.js";import{u as t}from"./index-BxQ2FslJ.js";import"./react-vendor-C_mTfbPB.js";const n={};function r({url:r,reconnectInterval:a=3e3,maxReconnectAttempts:c=5,onMessage:s,onConnect:o,onDisconnect:i,onError:u}={}){const[l,d]=e.useState(!1),[p,f]=e.useState(0),m=e.useRef(null),b=e.useRef(),g=e.useRef(),S=e.useCallback(()=>{if(r)return r;const e=n?.VITE_WS_URL||globalThis.VITE_WS_URL;return e&&"string"==typeof e?e:`${"https:"===window.location.protocol?"wss:":"ws:"}//${window.location.host}/ws`},[r]),h=e.useCallback(()=>{try{const e=S(),n=new WebSocket(e);m.current=n,n.onopen=()=>{d(!0),f(0),o?.(),n.send(JSON.stringify({type:"subscribe",channel:"vapi-events"})),g.current=setInterval(()=>{n.readyState===WebSocket.OPEN&&n.send(JSON.stringify({type:"ping"}))},3e4)},n.onmessage=e=>{try{const n=JSON.parse(e.data);switch(n.type){case"connected":case"pong":case"speech-update":break;case"vapi-event":w(n.data);break;case"call-started":t.info(`New call started: ${n.data?.phoneNumber}`);break;case"call-ended":t.success(`Call completed (${n.data?.duration}s)`);break;case"handoff-triggered":t.warning("Call requires human intervention!",{duration:1e4,important:!0});break;case"alert":v(n.data);break;default:s?.(n)}}catch(n){}},n.onerror=e=>{u?.(e)},n.onclose=()=>{d(!1),i?.(),g.current&&clearInterval(g.current),p<c?(f(p+1),b.current=setTimeout(()=>{h()},a)):t.error("WebSocket connection lost. Please refresh the page.")}}catch(e){u?.(e)}},[S,o,i,u,s,p,a,c]),k=e.useCallback(()=>{b.current&&clearTimeout(b.current),g.current&&clearInterval(g.current),m.current&&(m.current.close(),m.current=null),d(!1),f(0)},[]),y=e.useCallback(e=>!(!m.current||m.current.readyState!==WebSocket.OPEN||(m.current.send(JSON.stringify(e)),0)),[]),w=e=>{e.type,s?.({type:"vapi-event",data:e,timestamp:(new Date).toISOString()})},v=e=>{const n=e.severity||"info",r=e.message||"System alert";switch(n){case"high":case"critical":t.error(r,{duration:1e4,important:!0});break;case"medium":t.warning(r,{duration:7e3});break;default:t.info(r)}};return e.useEffect(()=>(h(),()=>{k()}),[]),{isConnected:l,reconnectCount:p,sendMessage:y,connect:h,disconnect:k}}let a=null;function c(e){return a||(a=r(e)),a}export{c as useGlobalWebSocket,r as useWebSocket};
