const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["js/statsService-jftlCrEA.js","js/supabase--zxEpOZW.js","js/supabase-DcuI07gC.js","js/react-vendor-C_mTfbPB.js","js/index-CC77URC1.js","js/ui-QtlX95wh.js","js/utils-BHC4lWY-.js","assets/index-BTRLeK_J.css"])))=>i.map(i=>d[i]);
import{r as e,j as t}from"./ui-QtlX95wh.js";import{u as s,P as a}from"./phone-BA2yAo7b.js";import{_ as n}from"./supabase-DcuI07gC.js";import{s as r}from"./supabase--zxEpOZW.js";import{c as i,a as l}from"./index-CC77URC1.js";const c=i("chevron-right",[["path",{d:"m9 18 6-6-6-6",key:"mthhwq"}]]),o=i("mail",[["path",{d:"m22 7-8.991 5.727a2 2 0 0 1-2.009 0L2 7",key:"132q7q"}],["rect",{x:"2",y:"4",width:"20",height:"16",rx:"2",key:"izxlao"}]]),d=i("map-pin",[["path",{d:"M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0",key:"1r0f0z"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}]]),m=i("plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]]),h=i("search",[["path",{d:"m21 21-4.34-4.34",key:"14j7rj"}],["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}]]),u=i("user",[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]]),x={async getClients(e){let t=r.from("clients_enriched").select("*").order("last_contact_date",{ascending:!1});e?.search&&(t=t.or(`first_name.ilike.%${e.search}%,last_name.ilike.%${e.search}%,phone.ilike.%${e.search}%,email.ilike.%${e.search}%`)),e?.status?.length&&(t=t.in("status",e.status)),e?.priority?.length&&(t=t.in("priority_level",e.priority)),e?.city&&(t=t.eq("city",e.city));const{data:s,error:a}=await t;if(a)throw a;return s},async getClient(e){const{data:t,error:s}=await r.from("clients_enriched").select("*").eq("id",e).single();if(s)throw s;return t},async upsertClient(e){const{data:t,error:s}=await r.from("clients").upsert(e).select().single();if(s)throw s;return t},async updateClient(e,t){const{data:s,error:a}=await r.from("clients").update(t).eq("id",e).select().single();if(a)throw a;return s},async getClientHistory(e){const[t,s,a]=await Promise.all([r.from("communication_history").select("*").eq("client_id",e).order("created_at",{ascending:!1}),r.from("interventions").select("*").eq("client_id",e).order("created_at",{ascending:!1}),r.from("sms_messages").select("*").eq("client_id",e).order("sent_at",{ascending:!1})]);return{communications:t.data||[],interventions:s.data||[],sms:a.data||[]}}},p={async getSMSMessages(e){let t=r.from("sms_messages").select("\n        *,\n        client:clients(first_name, last_name, phone)\n      ").order("sent_at",{ascending:!1});e?.priority?.length&&(t=t.in("priority",e.priority)),e?.dateFrom&&(t=t.gte("sent_at",e.dateFrom)),e?.dateTo&&(t=t.lte("sent_at",e.dateTo));const{data:s,error:a}=await t;if(a)throw a;return s},async getSMS(e){const{data:t,error:s}=await r.from("sms_messages").select("\n        *,\n        client:clients(*)\n      ").eq("id",e).single();if(s)throw s;return t},async updateSMSStatus(e,t,s){const a={status:t,..."delivered"===t&&{delivered_at:(new Date).toISOString()},...s&&{error_message:s}},{data:n,error:i}=await r.from("sms_messages").update(a).eq("id",e).select().single();if(i)throw i;return n}},g={async getInterventions(e){let t=r.from("interventions").select("\n        *,\n        client:clients(first_name, last_name, phone, address),\n        technician:technicians(first_name, last_name)\n      ").order("scheduled_date",{ascending:!1});e?.status?.length&&(t=t.in("status",e.status)),e?.priority?.length&&(t=t.in("priority",e.priority)),e?.serviceType&&(t=t.eq("service_type",e.serviceType)),e?.technician&&(t=t.eq("technician_id",e.technician)),e?.dateFrom&&(t=t.gte("scheduled_date",e.dateFrom)),e?.dateTo&&(t=t.lte("scheduled_date",e.dateTo));const{data:s,error:a}=await t;if(a)throw a;return s},async getTodayInterventions(){const e=r.from("today_interventions").select("*");let t;if("function"==typeof e?.order){const s=e.order("scheduled_date",{ascending:!1});t="function"==typeof s?.limit?await s.limit(50):await s}else t=await e;const{data:s,error:a}=t||{};if(a)throw a;return s},async getIntervention(e){const{data:t,error:s}=await r.from("interventions").select("\n        *,\n        client:clients(*),\n        technician:technicians(*)\n      ").eq("id",e).single();if(s)throw s;return t},async createIntervention(e){const{data:t,error:s}=await r.from("interventions").insert(e).select().single();if(s)throw s;return t},async updateIntervention(e,t){const{data:s,error:a}=await r.from("interventions").update({...t,updated_at:(new Date).toISOString()}).eq("id",e).select().single();if(a)throw a;return s},async startIntervention(e){return this.updateIntervention(e,{status:"in_progress",started_at:(new Date).toISOString()})},async completeIntervention(e,t,s){const{data:a}=await this.getIntervention(e),n=a?.started_at?Math.floor((Date.now()-new Date(a.started_at).getTime())/6e4):null;return this.updateIntervention(e,{status:"completed",completed_at:(new Date).toISOString(),final_price:t,duration_minutes:n,technician_notes:s})}},y={async getActiveAlerts(){const{getActiveAlerts:e}=await n(async()=>{const{getActiveAlerts:e}=await import("./statsService-jftlCrEA.js");return{getActiveAlerts:e}},__vite__mapDeps([0,1,2,3,4,5,6,7]));return await e()||[]},async getAlerts(e){let t=r.from("internal_alerts").select("\n        *,\n        client:clients(first_name, last_name, phone)\n      ").order("created_at",{ascending:!1});e?.priority?.length&&(t=t.in("priority",e.priority)),e?.status?.length&&(t=t.in("status",e.status));const{data:s,error:a}=await t;if(a)throw a;return s},async acknowledgeAlert(e,t){const{data:s,error:a}=await r.from("internal_alerts").update({status:"acknowledged",acknowledged_by:t,acknowledged_at:(new Date).toISOString()}).eq("id",e).select().single();if(a)throw a;return s},async resolveAlert(e,t){const{data:s,error:a}=await r.from("internal_alerts").update({status:"resolved",resolved_by:t,resolved_at:(new Date).toISOString()}).eq("id",e).select().single();if(a)throw a;return s}},f={async getStats(){const{getDashboardStats:e}=await n(async()=>{const{getDashboardStats:e}=await import("./statsService-jftlCrEA.js");return{getDashboardStats:e}},__vite__mapDeps([0,1,2,3,4,5,6,7])),t=await e();return{totalClients:t.clients.total,activeClients:t.clients.active,totalInterventions:t.interventions.month,todayInterventions:t.interventions.today,totalSMS:t.sms.sent,todaySMS:t.sms.sent,totalRevenue:t.revenue.year,monthRevenue:t.revenue.month,activeAlerts:0,p1Alerts:0,p2Alerts:0,averageResponseTime:15,customerSatisfaction:4.7}}},v={subscribeToAlerts(e){const t=r;return"function"!=typeof t?.channel?{_noop:!0}:t.channel("alerts").on("postgres_changes",{event:"*",schema:"public",table:"internal_alerts"},e).subscribe()},subscribeToSMS(e){const t=r;return"function"!=typeof t?.channel?{_noop:!0}:t.channel("sms").on("postgres_changes",{event:"INSERT",schema:"public",table:"sms_messages"},e).subscribe()},subscribeToInterventions(e){const t=r;return"function"!=typeof t?.channel?{_noop:!0}:t.channel("interventions").on("postgres_changes",{event:"*",schema:"public",table:"interventions"},e).subscribe()},subscribeToCalls(e){const t=r;return"function"!=typeof t?.channel?{_noop:!0}:t.channel("calls").on("postgres_changes",{event:"*",schema:"public",table:"vapi_calls"},e).subscribe()},unsubscribe(e){const t=r;if("function"==typeof t?.removeChannel)return t.removeChannel(e)}};function j(){const[n,r]=e.useState({}),[i,p]=e.useState(null),[g,y]=e.useState(""),{data:f=[],isLoading:v,refetch:j}=s({queryKey:["clients",n],queryFn:()=>x.getClients(n),refetchInterval:3e4});e.useEffect(()=>{const e=setTimeout(()=>{r(e=>({...e,search:g}))},300);return()=>clearTimeout(e)},[g]);const b=e=>{switch(e){case"P1":return"text-red-600 bg-red-100";case"P2":return"text-orange-600 bg-orange-100";case"P3":return"text-yellow-600 bg-yellow-100";case"P4":return"text-green-600 bg-green-100";default:return"text-gray-600 bg-gray-100"}},N=e=>{const t=e.replace(/\D/g,"");return 10===t.length?`(${t.slice(0,3)}) ${t.slice(3,6)}-${t.slice(6)}`:e};return t.jsxs("div",{className:"flex h-full",children:[t.jsxs("div",{className:l("flex-1 flex flex-col border-r",i&&"max-w-md"),children:[t.jsxs("div",{className:"p-4 border-b bg-white",children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsx("h2",{className:"text-xl font-semibold",children:"Clients"}),t.jsx("button",{className:"p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:t.jsx(m,{className:"h-5 w-5"})})]}),t.jsxs("div",{className:"relative",children:[t.jsx(h,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),t.jsx("input",{type:"text",placeholder:"Rechercher par nom, téléphone, email...",value:g,onChange:e=>y(e.target.value),className:"w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),t.jsxs("div",{className:"flex gap-2 mt-3",children:[t.jsxs("select",{className:"px-3 py-1 text-sm border rounded-lg",onChange:e=>r(t=>({...t,status:e.target.value?[e.target.value]:void 0})),children:[t.jsx("option",{value:"",children:"Tous les statuts"}),t.jsx("option",{value:"active",children:"Actifs"}),t.jsx("option",{value:"inactive",children:"Inactifs"})]}),t.jsxs("select",{className:"px-3 py-1 text-sm border rounded-lg",onChange:e=>r(t=>({...t,priority:e.target.value?[e.target.value]:void 0})),children:[t.jsx("option",{value:"",children:"Toutes priorités"}),t.jsx("option",{value:"P1",children:"P1 - Urgent"}),t.jsx("option",{value:"P2",children:"P2 - Municipal"}),t.jsx("option",{value:"P3",children:"P3 - Majeur"}),t.jsx("option",{value:"P4",children:"P4 - Standard"})]})]})]}),t.jsx("div",{className:"flex-1 overflow-y-auto",children:v?t.jsx("div",{className:"flex items-center justify-center h-32",children:t.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):0===f.length?t.jsxs("div",{className:"flex flex-col items-center justify-center h-32 text-gray-500",children:[t.jsx(u,{className:"h-8 w-8 mb-2"}),t.jsx("p",{children:"Aucun client trouvé"})]}):t.jsx("div",{className:"divide-y",children:f.map(e=>{return t.jsx("div",{onClick:()=>p(e),className:l("p-4 hover:bg-gray-50 cursor-pointer transition-colors",i?.id===e.id&&"bg-blue-50"),children:t.jsxs("div",{className:"flex items-start justify-between",children:[t.jsxs("div",{className:"flex-1",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("h3",{className:"font-medium text-gray-900",children:[e.first_name," ",e.last_name,e.company_name&&t.jsxs("span",{className:"text-gray-500 text-sm ml-2",children:["(",e.company_name,")"]})]}),e.priority_level&&t.jsx("span",{className:l("px-2 py-0.5 text-xs font-medium rounded-full",b(e.priority_level)),children:e.priority_level})]}),t.jsxs("div",{className:"mt-1 space-y-1",children:[t.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-600",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(a,{className:"h-3 w-3"}),N(e.phone)]}),e.email&&t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(o,{className:"h-3 w-3"}),e.email]})]}),e.address&&t.jsxs("div",{className:"flex items-center gap-1 text-sm text-gray-600",children:[t.jsx(d,{className:"h-3 w-3"}),e.address,", ",e.city]}),t.jsxs("div",{className:"flex items-center gap-4 text-xs text-gray-500",children:[t.jsxs("span",{children:[e.total_interventions||0," interventions"]}),t.jsxs("span",{children:[e.total_sms||0," SMS"]}),t.jsx("span",{className:"font-medium",children:(s=e.lifetime_value,new Intl.NumberFormat("fr-CA",{style:"currency",currency:"CAD"}).format(s||0))})]})]})]}),t.jsx(c,{className:"h-5 w-5 text-gray-400 mt-1"})]})},e.id);var s})})})]}),i&&t.jsx("div",{className:"flex-1 bg-white",children:t.jsx(_,{client:i,onClose:()=>p(null),onUpdate:()=>j()})})]})}function _({client:e,onClose:a,onUpdate:n}){const{data:r,isLoading:i}=s({queryKey:["client-history",e.id],queryFn:()=>x.getClientHistory(e.id),enabled:!!e.id});return t.jsxs("div",{className:"h-full flex flex-col",children:[t.jsxs("div",{className:"p-6 border-b",children:[t.jsxs("div",{className:"flex items-start justify-between",children:[t.jsxs("div",{children:[t.jsxs("h2",{className:"text-2xl font-semibold",children:[e.first_name," ",e.last_name]}),e.company_name&&t.jsx("p",{className:"text-gray-600",children:e.company_name})]}),t.jsx("button",{onClick:a,className:"p-2 hover:bg-gray-100 rounded-lg",children:"×"})]}),t.jsxs("div",{className:"mt-4 grid grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"text-sm text-gray-500",children:"Téléphone"}),t.jsx("p",{className:"font-medium",children:b(e.phone)})]}),e.email&&t.jsxs("div",{children:[t.jsx("label",{className:"text-sm text-gray-500",children:"Email"}),t.jsx("p",{className:"font-medium",children:e.email})]}),e.address&&t.jsxs("div",{className:"col-span-2",children:[t.jsx("label",{className:"text-sm text-gray-500",children:"Adresse"}),t.jsxs("p",{className:"font-medium",children:[e.address,", ",e.city," ",e.postal_code]})]})]}),t.jsxs("div",{className:"mt-4 flex gap-4",children:[t.jsxs("div",{className:"flex-1 p-3 bg-gray-50 rounded-lg",children:[t.jsx("p",{className:"text-sm text-gray-500",children:"Interventions"}),t.jsx("p",{className:"text-xl font-semibold",children:e.total_interventions||0})]}),t.jsxs("div",{className:"flex-1 p-3 bg-gray-50 rounded-lg",children:[t.jsx("p",{className:"text-sm text-gray-500",children:"SMS envoyés"}),t.jsx("p",{className:"text-xl font-semibold",children:e.total_sms||0})]}),t.jsxs("div",{className:"flex-1 p-3 bg-gray-50 rounded-lg",children:[t.jsx("p",{className:"text-sm text-gray-500",children:"Valeur totale"}),t.jsx("p",{className:"text-xl font-semibold",children:(c=e.lifetime_value,new Intl.NumberFormat("fr-CA",{style:"currency",currency:"CAD"}).format(c||0))})]})]})]}),t.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:i?t.jsx("div",{className:"flex items-center justify-center h-32",children:t.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{children:[t.jsx("h3",{className:"font-medium mb-3",children:"Interventions récentes"}),0===r?.interventions.length?t.jsx("p",{className:"text-sm text-gray-500",children:"Aucune intervention"}):t.jsx("div",{className:"space-y-2",children:r?.interventions.slice(0,5).map(e=>t.jsxs("div",{className:"p-3 border rounded-lg",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"font-medium",children:e.service_type}),t.jsx("span",{className:"text-sm text-gray-500",children:new Date(e.created_at).toLocaleDateString("fr-CA")})]}),t.jsx("p",{className:"text-sm text-gray-600 mt-1",children:e.problem_description})]},e.id))})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-medium mb-3",children:"SMS récents"}),0===r?.sms.length?t.jsx("p",{className:"text-sm text-gray-500",children:"Aucun SMS"}):t.jsx("div",{className:"space-y-2",children:r?.sms.slice(0,5).map(e=>t.jsxs("div",{className:"p-3 border rounded-lg",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:l("px-2 py-0.5 text-xs font-medium rounded-full","sent"===e.status?"bg-green-100 text-green-600":"bg-gray-100 text-gray-600"),children:e.status}),t.jsx("span",{className:"text-sm text-gray-500",children:new Date(e.sent_at).toLocaleDateString("fr-CA")})]}),t.jsx("p",{className:"text-sm text-gray-600 mt-1 line-clamp-2",children:e.message})]},e.id))})]})]})})]});var c}function b(e){const t=e.replace(/\D/g,"");return 10===t.length?`(${t.slice(0,3)}) ${t.slice(3,6)}-${t.slice(6)}`:e}const N=Object.freeze(Object.defineProperty({__proto__:null,ClientsView:j},Symbol.toStringTag,{value:"Module"}));export{j as C,y as a,p as b,N as c,g as i,v as r,f as s};
